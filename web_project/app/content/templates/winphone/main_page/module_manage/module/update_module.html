{% extends "base.html" %}
{% block link %}
    <link rel="stylesheet" href="{{ STATIC_URL }}file_upload/css/jquery.fileupload-ui.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}file_upload/css/jquery.fileupload.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}jquery-validate/jquery.validate.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}toast_message/jquery.toastmessage.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}app/content/module/update.css">

{% endblock %}
{% block content %}

    <div class="container">
        <div class="row-fluid span8">
            <h3>更新Win_Phone模块数据</h3>

            <form role="form" method="post" action="{% url "winphone_update_module" %}">
                <table class="table table-hover table-striped">
                    <tbody>
                    <tr>
                        <input type="hidden" class="form-control" id="id" name="id" value="{{ module.id }}">
                        <td><label for="title">模块标题</label></td>
                        <td><input type="text" class="form-control" id="title" name="title" value="{{ module.title }}">
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 30%"> 模块类型</td>
                        <td>
                            <select class="form-control" id="box_type" name="box_type" placeholder="">
                                {% for k,v in box_type_list %}
                                    {% if k == module.box_type %} }}
                                        <option value="{{ k }}" selected="selected">{{ v }}</option>
                                    {% else %}
                                        <option value="{{ k }}">{{ v }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="video_count_for_phone">phone视频个数</label></td>
                        <td><input type="text" class="form-control" id="video_count_for_phone"
                                   name="video_count_for_phone"
                                   value="{{ module.video_count_for_phone }}">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="video_count_for_phone">pad视频个数</label>
                        </td>
                        <td>
                            <input type="text" class="form-control" id="video_count_for_pad" name="video_count_for_pad"
                                   value="{{ module.video_count_for_pad }}">
                        </td>
                    </tr>
                    <tr>
                        <td><label for="cid">跳转CID</label></td>
                        <td><input type="text" class="form-control" id="cid" name="cid" value="{{ module.cid }}"></td>
                    </tr>
                    </tbody>
                </table>
                <button type="submit" class="btn btn-default">更新</button>
                <a class="btn btn-default" href="{% url 'winphone_modules' %}">返回</a>
            </form>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{{ STATIC_URL }}file_upload/js/vendor/jquery.ui.widget.js"></script>
    <script src="{{ STATIC_URL }}file_upload/js/jquery.iframe-transport.js"></script>
    <script src="{{ STATIC_URL }}file_upload/js/jquery.fileupload.js"></script>
    <script src="{{ STATIC_URL }}jquery-validate/jquery.validate.js"></script>
    <script src="{{ STATIC_URL }}toast_message/jquery.toastmessage.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            $("#li_iphone_module").addClass('active');
        });

        var url = '/content/img/upload';
        //初始化，主要是设置上传参数，以及事件处理方法(回调函数)

        $('#module-img-upload').fileupload({
            autoUpload: true,//是否自动上传
            url: url,//上传地址
            dataType: 'json',
            acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
            maxFileSize: 1048576,


            add: function (e, data) {
                var uploadErrors = [];
                var acceptFileTypes = /^image\/(gif|jpe?g|png)$/i;
                if ('type' in data.originalFiles[0] && !acceptFileTypes.test(data.originalFiles[0]['type'])) {
                    uploadErrors.push('上传图片格式错误!');
                }

                if ('size' in data.originalFiles[0] && data.originalFiles[0]['size'] > 1048576) {
                    uploadErrors.push('上传图片需要小于1M!');
                }

                if (uploadErrors.length > 0) {
                    show_error_msg(uploadErrors.join("\n"));
                } else {
                    data.submit();
                }
            },

            done: function (e, data) {//设置文件上传完毕事件的回调函数

                if ("e" in data.result && data.result["e"]["code"] < 0) {
                    $("#normal_button").show();
                    $("#normal-progress").hide();
                    show_error_msg("upload error:" + data.result["e"]["code"] + ':' + data.result["e"]["desc"]);
                    return;
                }

                $.each(data.result.files, function (index, file) {//
                    $("#normal-content").attr("src", file.url);
                    scoller_input = $("#normal-img-url")
                    scoller_input.attr('value', file.url)
                });

                $("#normal-progress").hide();
                $("#normal_success").show();
            },

            progressall: function (e, data) {//设置上传进度事件的回调函数

                // $("#normal_button").hide();
                $("#normal-progress").show();

                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#scoller-progress .bar').css(
                        'width',
                                progress + '%'
                );
            }

        });
        $("button.close").click(function () {
            $("#normal_success").hide();
            $("#normal_button").show();
            $("#normal-img-url").val("");
        })
    </script>
    <script type="text/javascript">
        $(function () {
            var validate_rules;
            validate_form = function (form_selector, options) {
                var default_options;
                console.log("in validate_form")
                console.log($(form_selector))
                default_options = {
                    errorPlacement: function (error, element) {
                        if (element.is(":checkbox")) {
                            return error.appendTo(element.next());
                        } else {
                            element.addClass('error');
                            error.css("padding-left", "0px")
                            return error.appendTo(element.parent());
                        }
                    },
                    submitHandler: function (form) {
                        return form.submit();
                    },
                    //success: function(label) {
                    //     console.log(label)
                    //    return label.html("&nbsp;").addClass("checked");
                    //  },
                    highlight: function (element, errorClass) {
                        return $(element).parent().find("." + errorClass).removeClass("checked");
                    }
                };
                options = $.extend(default_options, options);
                return $(form_selector).validate(options);
            };
            validate_rules = {
                'video_count_for_phone': {
                    'required': true,
                    'maxlength': 6
                },
                'box_id': {
                    'required': true,
                    'maxlength': 6
                },
                'title': {
                    'required': true
                }
            }
            validate_form('form', {
                        ignore: ':hidden:not(input[id*=normal-img-url])',
                        rules: validate_rules
                    }
            );
        })

    </script>
    <script type="text/javascript">

        $(function () {
            $().toastmessage({
                text: $($('.success')[0]).text(),
                sticky: false,
                position: 'middle-center',
                type: 'success'
            });
            if ($('.success').length > 0) {
                $().toastmessage('showSuccessToast');
            }
            if ($('.error').length > 0) {
                $().toastmessage('showErrorToast');
            }
    </script>

{% endblock %}
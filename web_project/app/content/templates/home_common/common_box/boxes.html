{% extends "base.html" %}
{% load util_tags %}

{% block link %}

    <link href="{{ STATIC_URL }}select2/select2.css" rel="stylesheet"/>
    <link href="{{ STATIC_URL }}select2/select2-bootstrap.css" rel="stylesheet"/>
    <link rel="stylesheet" href="{{ STATIC_URL }}file_upload/css/jquery.fileupload-ui.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}file_upload/css/jquery.fileupload.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}jquery-validate/jquery.validate.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}toast_message/jquery.toastmessage.css">
    <style type="text/css">
        div.btn-block {
            text-align: right;
            margin-bottom: 10px;
        }

        div.pull-right a.btn {
            margin-left: 5px;
            margin-bottom: 5px;
        }

        .table {
            clear: both;
        }

        a.btn-table {
            padding: 2px 5px;
        }

        #save_position_btn {
            float: left;
        }

        #hidden-form {
            margin-bottom: 10px;
        }

        .pagination {
            float: left;
        }

        .pagination > .current {
            vertical-align: 3px;
        }

        tbody#sortable {
            font-size: 13px;
        }

        tbody > tr > td > input[type="text"] {
            font-size: 13px;
        }
        td.canBeEdit {
            max-width: 195px;
            min-width: 150px;
        }
        td.text-sub {
            max-width: 160px;
            min-width: 120px;
            width: auto;
        }
        .text-block {
            display: none;
            max-width: 195px;
            min-width: 150px;
        }
        .text-block > textarea {
            font-size: 13px;
            padding:0;
            margin: 0;
            display: block;
            max-width: 195px;
            min-width: 150px;
            max-height: 100px;
            resize: vertical;
        }
        .text-sub > .text-block > textarea {
            max-width: 150px;
            min-width: 120px;
        }
        .text-block > button {
            float: right;
            margin-left: 3px;
        }
    </style>

{% endblock %}

{% block content %}
    <div class="row-fluid">
        <h4>推荐池公用抽屉列表</h4>
    </div>
    {% if not request.user.is_normal_user %}
        <div class="btn-block">
            <form method="post" id="hidden-form">
                <input type="hidden" name="item_ids" id="item_ids"/>
                <button type="button" class="btn" id="save_position_btn"><i class="icon-sort"></i>保存顺序</button>
                </form>
        <a href="#myModal" role="button" class="btn" data-toggle="modal"><i class="icon-plus"></i>新增抽屉</a>
    </div>
    {% endif %}

    <div class="row-fluid">
        <table class="table table-striped table-hover">
            <thead>
            <th>抽屉ID</th>
            <th>标题</th>
            <th>操作</th>
            </thead>
            <tbody id="sortable">
            {% for box in items %}
                <tr id="box_{{ box.id }}" value="{{ box.id }}" class="sort-item">
                    <td>
                        {{ box.id }}
                    </td>
                    <td class="canBeEdit">
                        <div class="text-block">
                            <label for="subtitle-{{ box.id }}"></label>
                            <textarea cols="3" rows="2" class="edit-area"
                                      id="subtitle-{{ box.id }}">{{ box.title }}</textarea>
                            <button type="button" class="modify-text  btn btn-mini btn-info">确认</button>
                            <button type="button" class="recover-text btn btn-mini">取消</button>
                        </div>
                        <div class="text-piece">{{ box.title }}</div>
                    </td>
                    <td colspan="1">
                        <a class="btn btn-small btn-info btn-table"
                           href="{% url "home_common_boxes_videos_in_box" current_box_page box.id %}">
                            <i class="icon-film"></i>视频</a>
                    {% if not request.user.is_normal_user %}
                        {% box_btns_show_perm box.id request.user 1  as perm_flag %}
                        {% if perm_flag %}
                        <a class="btn btn-small btn-danger btn-table del"
                           href="{% url "home_common_boxes_delete_box" box.id %}" title="删除">
                            <i class="icon-trash"></i>删除</a>

{#                        <a class="btn btn-small btn-warning btn-table"#}
{#                                   href="{% url "show_main_box_perm" %}?box_id={{ box.id }}&platform=common&src=main_page_recommend">#}
{#                                    <i class="icon-user-md"></i>权限</a>#}
                                {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% if not items %}
        <div class="row-fluid">
            <div class="col-sm-8">
                <div class="alert">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>Warning!</strong> 相关首页模块数据为空,请创建模块数据。
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row-fluid">
        <form method="post" id="save_position_form">
        </form>
    </div>

    <div class="row-fluid">
        {% include  'home_common/common_box/add_box.html' %}
    </div>
    {% include "common_module/pagination.html" %}



{% endblock %}




{% block js %}
    <script src="{{ STATIC_URL }}select2/select2.js"></script>
    <script src="{{ STATIC_URL }}file_upload/js/vendor/jquery.ui.widget.js"></script>
    <script src="{{ STATIC_URL }}file_upload/js/jquery.iframe-transport.js"></script>
    <script src="{{ STATIC_URL }}file_upload/js/jquery.fileupload.js"></script>
    <script src="{{ STATIC_URL }}jquery-validate/jquery.validate.js"></script>
    <script src="{{ STATIC_URL }}toast_message/jquery.toastmessage.js"></script>
    <script type="text/javascript">
        function save_position_btn_func(){
            var item_ids = $('#item_ids').val();
            $.ajax({
                type:'POST',
                dataType: 'json',
                url: '/content/common_content/boxes',
                data: {
                    item_ids: item_ids
                },
                success: function(data){
                    if(data.status === 'success'){
                        $().toastmessage({
                            position: 'middle-center'
                        });
                        $().toastmessage('showSuccessToast', '操作成功');
                        setTimeout(function(){location.reload()},1000);
                    }else{
                        $().toastmessage('showErrorToast',"操作失败")
                    }
                }

            })
        }

        {% include "common_module/sort_edit_del.js" %}
        {% include "common_module/set_table_width.js" %}

        function change_content_according_to_box_type() {
            if ($('#box_type').val() === '2') {
                //轮播图模块隐藏图片跳转链接
                $("#image_link_div").hide();
            } else {
                $("#image_link_div").show();
            }
        }

        $(document).ready(function () {
            change_content_according_to_box_type();
            $("button.close").click(function () {
                $("#normal_success").hide();
                $("#normal_button").show();
            });
        });

        $(document).ready(function () {
            $(".canBeEdit").dblclick(function () {
                var text_area = $(this).children('div.text-block').show().children('textarea');
                var temp_str = text_area.val();
                text_area.show().focus().val('').val(temp_str);
                $(this).children('div.text-piece').hide();
            });
            $(".recover-text").click(function () {
                var textarea_div = $(this).parent();
                textarea_div.hide().next().show();
            });
            $(".modify-text").click(function () {
                var textarea = $(this).prevAll('textarea');
                var id_arr = textarea.attr('id').split('-');
                var box_id = id_arr[1];
                var value = textarea.val();
                $.ajax({
                    url: '/content/common_content/box/update_box_title',
                    type: "POST",
                    dataType: 'json',
                    data: {
                        box_id: box_id,
                        value: value
                    },
                    success: function (data) {
                        textarea.parent().hide().nextAll('.text-piece').text(value).show();
                        $().toastmessage({
                            position: 'middle-center'
                        });
                        if(data.status === 'success'){
                            $().toastmessage('showSuccessToast', '操作成功');
                        }else{
                            $().toastmessage('showErrorToast', '操作失败');
                        }
                    }
                })
            });


            $(".edit-area").keydown(function (e) {
                if (e.ctrlKey && e.keyCode == 13) {
                    // Ctrl-Enter pressed
                    $(this).nextAll('.modify-text').triggerHandler('click');
                }
            });


            $('#box_type').change(function () {
                change_content_according_to_box_type()
            });

            var url = '/content/img/upload';
            //初始化，主要是设置上传参数，以及事件处理方法(回调函数)

            $('#box-img-upload').fileupload({
                autoUpload: true,//是否自动上传
                url: url,//上传地址
                dataType: 'json',
                acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
                maxFileSize: 1048576,


                add: function (e, data) {
                    var uploadErrors
                            = [];
                    var acceptFileTypes = /^image\/(gif|jpe?g|png)$/i;
                    if ('type' in data.originalFiles[0] && !acceptFileTypes.test(data.originalFiles[0]['type'])) {
                        uploadErrors.push('上传图片格式错误!');
                    }

                    if ('size' in data.originalFiles[0] && data.originalFiles[0]['size'] > 1048576) {
                        uploadErrors.push('上传图片需要小于1M!');
                    }

                    if (uploadErrors.length > 0) {
                        show_error_msg(uploadErrors.join("\n"));
                    } else {
                        data.submit();
                    }
                },

                done: function (e, data) {//设置文件上传完毕事件的回调函数

                    if ("e" in data.result && data.result["e"]["code"] < 0) {
                        $("#normal_button").show();
                        $("#normal-progress").hide();
                        show_error_msg("upload error:" + data.result["e"]["code"] + ':' + data.result["e"]["desc"]);
                        return;
                    }

                    $.each(data.result.files, function (index, file) {//
                        $("#normal-content").attr("src", file.url);
                        $("#normal-content").show();
                        scoller_input = $("#normal-img-url")
                        scoller_input.attr('value', file.url)
                    });

                    $("#normal-progress").hide();
                    $("#normal_success").show();
                },

                progressall: function (e, data) {//设置上传进度事件的回调函数

                    $("#normal_button").hide();
                    $("#normal-progress").show();

                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('#scoller-progress .bar').css(
                            'width',
                            progress + '%'
                    );
                }

            });
        });
        function show_error_msg(msg) {

            $("#formErrorModal .modal-body p").text(msg);
            $("#formErrorModal").modal();

        }

    </script>
    <script type="text/javascript">
        $('#state-all-pick').click(function () {
            if ($(this).is(':checked')) {
                $("input:checkbox.module-status-tag").prop("checked", true)
            } else {
                $("input:checkbox:checked.module-status-tag").attr("checked", false)
            }
        })
        function collect_change_module_ids() {
            var module_id_array = []
            var module_ids = ''
            $("input:checkbox:checked.module-status-tag").each(function () {
                module_id_array.push($(this).parent().parent().attr('value'))
            })
            module_ids = module_id_array.join(",")
            return module_ids
        }

        $('.module-state').click(function () {
            var module_ids = ""
            var val = $(this).attr("value")
            var source = {
                '1': '开启',
                '0': '关闭'
            }
            module_ids = collect_change_module_ids()
            if (module_ids.length > 0) {
                $.ajax({
                    url: '/content/common_content/box/update_status',
                    type: "POST",
                    dataType: 'json',
                    data: {
                        module_ids: module_ids,
                        value: val
                    },
                    success: function (data) {
                        for (var i = 0; i < data.module_ids.length; i++) {
                            $('#status_' + data.module_ids[i]).html(source[val])
                        }
                        ;
                        $().toastmessage({
                            position: 'middle-center'
                        });
                        $().toastmessage('showSuccessToast', '操作成功');
                    }
                })
            }
        })
    </script>
    <script type="text/javascript">
        {% include "home_common/common_box/_module_validate.js" %}
    </script>

    <link href="{{ STATIC_URL }}bootstrap-editable-1.5.1/bootstrap-editable/css/bootstrap-editable.css"
          rel="stylesheet"/>
    <script src="{{ STATIC_URL }}bootstrap-editable-1.5.1/bootstrap-editable/js/bootstrap-editable.js"></script>

{% endblock %}
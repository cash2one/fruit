{% extends "base.html" %}
{% load util_tags %}

{% block link %}
    <style type="text/css">
        .active-item-shadow {
            box-shadow: rgba(133, 133, 133, 0.1) 0 0 5px 2px, rgba(133, 133, 133, 0.3) 0 0 2px;
        }

        .btn-table {
            padding: 2px 5px;
        }
    </style>
    <link href="{{ STATIC_URL }}select2/select2-bootstrap.css" rel="stylesheet"/>
    <link rel="stylesheet" href="{{ STATIC_URL }}toast_message/jquery.toastmessage.css">
{% endblock %}
{% block navigation %}
    <div class="navigation-div">
        <ul class="breadcrumb">
            <li>频道管理<span class="divider">/</span></li>
            <li><a style="text-decoration: none;" href="/content/android/new_channels">Android频道</a><span
                    class="divider">/</span></li>
            <li><a href="{% url 'android_sub_channel' %}?select_channel={{ this_channel.id }}">{{ this_channel.title }}频道</a><span
                    class="divider">/</span></li>
            <li class="active">{{ this_subchannel.title }}子频道-抽屉列表</li>

        </ul>
    </div>
{% endblock %}

{% block content %}
    <div class="row-fluid" style="height: 50px">

        <div class="pull-left">
            <a class="btn" href="{% url 'android_sub_channel' %}?select_channel={{ this_channel.id }}"><i
                    class="icon-circle-arrow-left"></i>返回</a>
        </div>
        {% box_btns_show_perm this_channel.id request.user 4 as perm_flag %}
        {% if perm_flag %}
            <div class="pull-right ">
                {#            <a class="btn" href="#"><i class="icon-mobile-phone"></i>预览</a>#}
                {#            <a class="btn publish" id="publish" href="#"><i class="icon-bullhorn"></i>发布</a>#}
                <a class="btn box-state" value="1" href="#"><i class="icon-ok"></i>开启</a>
                <a class="btn box-state" value="0" href="#"><i class="icon-off"></i>关闭</a>
                <input type="hidden" name="item_ids" id="item_ids"/>
                <input type="hidden" name="this_channel_id" id="this_channel_id" value="{{ this_channel.id }}"/>
                <input type="hidden" name="this_subchannel_id" id="this_subchannel_id"
                       value="{{ this_subchannel.id }}"/>
                <button type="button" class="btn" id="save_position_btn"><i class="icon-sort"></i>保存顺序</button>
                <a href="#myModal" role="button" class="btn" data-toggle="modal"><i class="icon-plus"></i>新增抽屉</a>
            </div>
        {% endif %}
    </div>

    <table class="table table-striped">
        <thead>
        <th><input type="checkbox" id="state-all-pick"></th>
        <th>抽屉ID</th>
        <th>标题</th>
        <th>类型</th>
        <th>phone只显示一个单元?</th>
        <th>状态(开/关)</th>
        <th>操作</th>
        </thead>
        <tbody id="sortable">
        {% for module in modules %}
            <tr id="module_{{ module.id }}" value="{{ module.id }}" class="sort-item">
                <td><input type="checkbox" class="box-state-tag"></td>
                <td>{{ module.id }}</td>
                <td>{{ module.title }}</td>
                <td>
                    {{ subchannel_box_types_hash|dict_get:module.module_type }}
                <td>
                    {% if perm_flag %}
                        <a class="phone_display" href="#" id="phone_one_unit" data-type="select"
                           data-pk="{{ module.id }}"
                           data-url="/content/android/update_status/subchannel/module" data-title="状态管理"
                           data-value={{ module.phone_one_unit }}></a>
                    {% else %}
                        {% if module.phone_one_unit == 1 %}是{% else %}否{% endif %}
                    {% endif %}
                </td>
                <td class="out_pick td-state" id="status_{{ module.id }}">
                    {{ module_state_hash|dict_get:module.state }}
                </td>

                <td colspan="2">
                    {% if perm_flag %}
                        <a class="btn btn-small btn-table"
                           href="{% url "android_query_sub_channel_module" %}?module_id={{ module.id }}&channel_id={{ this_channel.id }}&subchannel_id={{ this_subchannel.id }}">
                            <li class="icon-edit"></li>
                            修改</a>
                        <a class="btn btn-danger btn-small del btn-table"
                           href="{% url "android_delete_sub_channel_module" %}?module_id={{ module.id }}&channel_id={{ this_channel.id }}&subchannel_id={{ this_subchannel.id }}">
                            <li class="icon-trash"></li>
                            删除</a>
                    {% endif %}
                    <a class="btn btn-small btn-info btn-table"
                       href="{% url 'android_sub_channel_module_items' %}?select_channel={{ this_channel.id }}&select_subchannel={{ this_subchannel.id }}&select_module={{ module.id }}">
                        <li class="icon-film"></li>
                        视频</a>
                    {% if module.module_type != 1 %}
                    <a class="btn-small btn btn-success btn-table"
                       href="{% url 'show_single_plan' %}?channel_id={{ this_channel.id }}&subchannel_id={{ this_subchannel.id }}&module_id={{ module.id }}&platform=android">
                        <li class="icon-folder-open"></li>
                        抓取</a>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>


    {% if not channels %}
        <div class="row-fluid">
            <div class="col-sm-8">
                <div class="alert">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>Warning!</strong> 频道数据为空,请创建频道数据。
                    <a href="{% url 'android_new_channels' %}">创建频道</a>
                </div>
            </div>
        </div>
    {% else %}
        {% if not subchannels %}
            <div class="col-sm-8">
                <div class="alert">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>Warning!</strong> 该频道下没有精选子频道，请创建。
                    <a href="{% url 'android_sub_channel' %}?select_channel={{ this_channel.id }}  ">创建子频道</a>
                </div>
            </div>
        {% else %}

            {% if not modules %}
                <div class="row-fluid">
                    <div class="col-sm-8">
                        <div class="alert">
                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                            <strong>Warning!</strong> 子频道模块数据为空,请创建子频道模块数据。
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}

        <div class="row-fluid">
            {% include  'android/channel/sub_channel_box/add_subchannel_box.html' %}
        </div>
    {% endif %}

{% endblock %}


{% block js %}
    <script src="{{ STATIC_URL }}toast_message/jquery.toastmessage.js"></script>
    <script type="text/javascript">

        {% include "common_module/sort_edit_del.js" with reorder_url="/content/android/subchannel/modules" %}

        {% include "common_module/state_switch_basic.js" %}

        $(document).ready(function () {

            var count_selector = $("#count");
            var jump_selector = $("#jump_type");
            count_selector.change(function () {
                var unit_num = $(this).val();
                var unit_total = $('#count option:last').val();
                for (var start = 1; start <= unit_total; start++) {
                    if (start > unit_num) {
                        $("#unit_type_div_" + start.toString()).css('display', 'none');
                    }
                    else {
                        $("#unit_type_div_" + start.toString()).css('display', 'inline-block');
                    }
                }
            });
            jump_selector.change(function () {
                var jump_type = $(this).val();
                if (jump_type === 'by_sub_channel') {
                    $("#jump_to_subchannel").css('display', 'block');
                    $("#condition").hide();
                } else if (jump_type === 'by_filter') {
                    $("#jump_to_subchannel").css('display', 'none');
                    $("#condition").show();
                } else {
                    $("#jump_to_subchannel").css('display', 'none');
                    $("#condition").hide();
                }
            });

            $('#module_type').change(function () {
                var module_type = $(this).val();
                if (module_type === '1') {
                    for (var i = 1; i <= 10; i++) {
                        $('#unit_type_select_' + i).prepend("<option value='slider_images'>轮播图</option>")
                    }
                    $('#slider_video_count_tr').show()
                    $('#title_jump_type_tr').hide()
                } else {
                    for (var i = 1; i <= 10; i++) {
                        $("#unit_type_select_" + i + " option[value='slider_images']").remove()
                    }
                    $('#slider_video_count_tr').hide()
                    $('#title_jump_type_tr').show()
                }
            })
            $('#module_type').trigger('change')
            count_selector.trigger('change');
            jump_selector.trigger('change');

            $('.phone_display').editable({
                showbuttons: false,
                source: [
                    {value: 1, text: '是'},
                    {value: 0, text: '否'}
                ]
            });


            {#            $('#state-all-pick').click(function () {#}
            {#                if ($(this).is(':checked')) {#}
            {#                    $("input:checkbox.box-state-tag").prop("checked", true)#}
            {#                } else {#}
            {#                    $("input:checkbox:checked.box-state-tag").attr("checked", false)#}
            {#                }#}
            {#            });#}
            {#            $('input:checkbox.box-state-tag').click(function () {#}
            {#                is_all_boxes_checked();#}
            {#            });#}
            $('.box-state').click(function () {
                var source = {
                    '1': '开启',
                    '0': '关闭'
                };
                var val = $(this).attr("value");
                var box_ids = collect_change_box_ids();
                if (box_ids.length > 0) {
                    $.ajax({
                        url: '/content/update_items_state',
                        type: "POST",
                        dataType: 'json',
                        data: {
                            item_ids: box_ids,
                            value: val,
                            target_model: 'AndroidSubChannelModule'
                        },
                        success: function (data) {
                            $().toastmessage({
                                position: 'middle-center'
                            });

                            if (data.status === 'success') {
                                for (var i = 0; i < data.item_ids.length; i++) {
                                    $('#status_' + data.item_ids[i]).html(source[val])
                                }
                                $().toastmessage('showSuccessToast', '操作成功');
                            } else {
                                $().toastmessage('showErrorToast', '操作失败');
                            }
                            $("input:checkbox.box-state-tag").prop('checked', false);
                            $('#state-all-pick').prop("checked", false)
                        }
                    })
                }
            });

        });
    </script>

    {% include "subchannel_module/module_validate.html" %}

    <link href="{{ STATIC_URL }}bootstrap-editable-1.5.1/bootstrap-editable/css/bootstrap-editable.css"
          rel="stylesheet"/>
    <script src="{{ STATIC_URL }}bootstrap-editable-1.5.1/bootstrap-editable/js/bootstrap-editable.js"></script>

{% endblock %}
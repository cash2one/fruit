{% extends "base.html" %}
{% load util_tags %}

{% block link %}

    <link href="{{ STATIC_URL }}select2/select2.css" rel="stylesheet"/>
    <link href="{{ STATIC_URL }}select2/select2-bootstrap.css" rel="stylesheet"/>
    <link rel="stylesheet" href="{{ STATIC_URL }}file_upload/css/jquery.fileupload-ui.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}file_upload/css/jquery.fileupload.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}jquery-validate/jquery.validate.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}toast_message/jquery.toastmessage.css">

    <style type="text/css">
        .active-item-shadow {
            box-shadow: rgba(133, 133, 133, 0.1) 0 0 5px 2px, rgba(133, 133, 133, 0.3) 0 0 2px;
        }
        button#save_position_btn {
            margin-left: 8px;
        }
    </style>

{% endblock %}

{% block content %}
    <div class="row-fluid">
        <h4>日志查看 >> job: {{ job.id }} | {{ job.virtual_name }} </h4>
    </div>
    <div class="row-fluid pull-right">
            <a class="btn" href="javascript:history.go(-1)"><i class="icon-circle-arrow-left"></i>返回</a>
    </div>
    <div class="row-fluid">
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <th>视频IDs</th>
            <th>标题</th>
            <th>位置</th>
            <th>执行时间</th>
            </thead>
            {% for log in logs  %}
                <tr>
                    <td>
                        {% for vid in log.video_id_list %}
                            <div>
                                {{ vid }}
                            </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for title in log.title_list %}
                            <div>
                                {{ title }}
                            </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for index in log.index_list %}
                            <div>
                                {{ index }}
                            </div>
                        {% endfor %}
                    </td>
                    <td>{{ log.executed_at }}</td>
                </tr>
            {% endfor %}
        </table>
    </div>

    {% if not logs %}
        <div class="row-fluid">
            <div class="col-sm-8">
                <div class="alert">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>Warning!</strong> 日志为空!
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}


{% block js %}
    <script src="{{ STATIC_URL }}select2/select2.js"></script>
    <script src="{{ STATIC_URL }}file_upload/js/vendor/jquery.ui.widget.js"></script>
    <script src="{{ STATIC_URL }}file_upload/js/jquery.iframe-transport.js"></script>
    <script src="{{ STATIC_URL }}file_upload/js/jquery.fileupload.js"></script>
    <script src="{{ STATIC_URL }}jquery-validate/jquery.validate.js"></script>
    <script src="{{ STATIC_URL }}toast_message/jquery.toastmessage.js"></script>
    <script type="text/javascript">
        function save_position_btn_func() {
            var item_ids = $('#item_ids').val();
            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: '/content/android/video_lists',
                data: {
                    item_ids: item_ids
                },
                success: function (data) {
                    if (data.status === 'success') {
                        $().toastmessage({
                            position: 'middle-center'
                        });
                        $().toastmessage('showSuccessToast', '操作成功');
                        setTimeout(function () {
                            location.reload()
                        }, 1000);
                    } else {
                        $().toastmessage({
                            position: 'middle-center'
                        });
                        $().toastmessage('showErrorToast', "操作失败")
                    }
                }
            })
        }

        {% include "common_module/sort_edit_del.js" %}

        $(document).ready(function () {

            $("button.close").click(function () {
                $("#normal_success").hide();
                $("#normal_button").show();
            })

        });
        $(function () {

            $('.youku_channel_pick').editable({
                showbuttons: false,
                source: [
                    {value: 1, text: '是'},
                    {value: 0, text: '否'}
                ]
            });
           $('.multiply_units_pick').editable({
                showbuttons: false,
                source: [
                    {value: 1, text: '是'},
                    {value: 0, text: '否'}
                ]
            });

            var url = '/content/img/upload';
            //初始化，主要是设置上传参数，以及事件处理方法(回调函数)

            $('#module-img-upload').fileupload({
                autoUpload: true,//是否自动上传
                url: url,//上传地址
                dataType: 'json',
                acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
                maxFileSize: 1048576,


                add: function (e, data) {
                    var uploadErrors
                            = [];
                    var acceptFileTypes = /^image\/(gif|jpe?g|png)$/i;
                    if ('type' in data.originalFiles[0] && !acceptFileTypes.test(data.originalFiles[0]['type'])) {
                        uploadErrors.push('上传图片格式错误!');
                    }

                    if ('size' in data.originalFiles[0] && data.originalFiles[0]['size'] > 1048576) {
                        uploadErrors.push('上传图片需要小于1M!');
                    }

                    if (uploadErrors.length > 0) {
                        show_error_msg(uploadErrors.join("\n"));
                    } else {
                        data.submit();
                    }
                },

                done: function (e, data) {//设置文件上传完毕事件的回调函数

                    if ("e" in data.result && data.result["e"]["code"] < 0) {
                        $("#normal_button").show();
                        $("#normal-progress").hide();
                        show_error_msg("upload error:" + data.result["e"]["code"] + ':' + data.result["e"]["desc"]);
                        return;
                    }

                    $.each(data.result.files, function (index, file) {//
                        $("#normal-content").attr("src", file.url);
                        $("#normal-content").show();
                        scoller_input = $("#normal-img-url")
                        scoller_input.attr('value', file.url)
                    });

                    $("#normal-progress").hide();
                    $("#normal_success").show();
                },

                progressall: function (e, data) {//设置上传进度事件的回调函数

                    $("#normal_button").hide();
                    $("#normal-progress").show();

                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('#scoller-progress .bar').css(
                            'width',
                            progress + '%'
                    );
                }

            });
        });
        function show_error_msg(msg) {

            $("#formErrorModal .modal-body p").text(msg);
            $("#formErrorModal").modal();

        }

    </script>
    <script type="text/javascript">
        function collect_channel_ids_with_order() {
            children = $("#sortable").children();
            ret = '';
            for (i = 0; i < children.length; i++) {
                child = children[i];
                ret += $(child).attr('value') + ',';
            }
            return ret.substring(0, ret.length - 1);
        }

        $("#save_position_btn").click(function () {
                item_ids = collect_channel_ids_with_order();
                if (item_ids == '') {
                    alert('没有要排序的内容');
                    return false;
                }
                $("#item_ids").val(item_ids);
        });

        $(function () {
            var validate_rules;
            validate_form = function (form_selector, options) {
                var default_options;
                console.log("in validate_form")
                console.log($(form_selector))
                default_options = {
                    errorPlacement: function (error, element) {
                        if (element.is(":checkbox")) {
                            return error.appendTo(element.next());
                        } else {
                            element.addClass('error');
                            error.css("padding-left", "0px")
                            return error.appendTo(element.parent());
                        }
                    },
                    submitHandler: function (form) {
                        return form.submit();
                    },
                    success: function (label) {
                        // console.log(label)
                        return label.html("&nbsp;").addClass("checked");
                    },
                    highlight: function (element, errorClass) {
                        return $(element).parent().find("." + errorClass).removeClass("checked");
                    }
                };
                options = $.extend(default_options, options);
                return $(form_selector).validate(options);
            };
            validate_rules = {
                'video_count_for_phone': {
                    'required': true,
                    'maxlength': 6
                },
                'video_count_for_pad': {
                    'required': true,
                    'maxlength': 6
                },
                'title': {
                    'required': true
                }

            }

            validate_rules['image_link'] = {
                'url': true,
                'required': true
            }
            validate_rules['normal_img'] = {
                'required': true
            }

            validate_form('form#add-new-module', {
                        ignore: ':hidden:not(input[id*=normal-img-url])',
                        rules: validate_rules
                    }
            );
        })

    </script>

    <link href="{{ STATIC_URL }}bootstrap-editable-1.5.1/bootstrap-editable/css/bootstrap-editable.css"
          rel="stylesheet"/>
    <script src="{{ STATIC_URL }}bootstrap-editable-1.5.1/bootstrap-editable/js/bootstrap-editable.js"></script>

{% endblock %}
{% extends "base.html" %}

{% block link %}
    <style type="text/css">
        #htop {
            display: inline-block;
        }

        .btn-top {
            float: right;
            display: inline-block;
        }

        .btn-top > .btn {
            margin-left: 10px;
        }

        .alert-info {
            margin-top: 20px;
        }

        .input-prepend {
            min-width: 855px;
        }

        #filter_name {
            min-width: 250px;
        }

        #filter_block {
            display: none;
        }

        #filter_block .input-prepend {
            min-width: initial;
        }

        .filter_text {
            cursor: pointer;
            display: inline-block;
            color: #0088cc;
        }

        .category {
            display: none;
        }

        .handle_block {
            min-width: 220px;
        }

        .ui-autocomplete {
            max-height: 180px;
            max-width: 350px;
            width: 100%;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
            z-index: 2000;
        }

        /* IE 6 doesn't support max-height */
        * html .ui-autocomplete {
            height: 180px;
        }

        #select_wrap {
            overflow: auto;
        }
    </style>

{% endblock %}

{% block content %}

    <div class="row-fluid input-prepend">
        <div>
            <h4 id="htop"><span style="font-weight: normal;">{{ ask_name }}</span>的抓取计划管理</h4>

        </div>

    </div>
    {% if jobs %}
        <div class="control-group">
            <div id="filter_block">
                <label class="control-label" for="filter_name"></label>

                <div class="controls">
                    <div class="input-prepend">
                        <span class="add-on"><i class="icon-filter"></i></span>
                        <input class="span2" id="filter_name" type="text" title="键入文字对已存在的抓取计划进行筛选">

                    </div>
                    <div class="filter_text" id="fade_filter">
                        收起
                    </div>
                </div>
            </div>
            <div class="filter_text" id="display_filter">
                虚名称筛选
            </div>
        </div>
    {% endif %}

    {% if jobs %}
        <table class="table table-striped">
            <thead>
            <th>任务id</th>
            <th>虚拟名称</th>
            <th class="category">子频道或模块名称</th>
            <th>运行类型</th>
            <th>时间间隔/定期时间</th>
            <th>自动上线?</th>
            <th>抓取个数限制</th>
            {% if user.is_super %}
                <th>操作</th>
            {% endif %}
            </thead>

            <tbody id="sortable">
            {% for job in jobs %}
                <tr id="module_{{ item.id }}" value="{{ job.id }}">
                    <td>{{ job.id }}</td>
                    <td class="virtual_name"><a title="点击查看原始数据源" href="{{ job.query_data_src_url }}"
                                                target="_blank">{{ job.virtual_name }}</a></td>
                    <td class="category">{{ job.category_name }}</td>
                    <td>{% if job.cron %}每天固定时间{% else %}间隔时间{% endif %}</td>
                    <td>{% if job.cron %}每天{{ job.cron }}{% else %}每{{ job.get_interval_display }}分钟{% endif %}</td>
                    <td>{% if job.is_auto_published %}是{% else %}否{% endif %}</td>
                    <td>{% if job.max_fetch_count %}{{ job.max_fetch_count }}{% else %}无限制{% endif %}</td>
                    {% if user.is_super %}
                        <td colspan="2" class="handle_block">
                            <a class="btn btn-small btn-success run" data-toggle="tooltip" data-job="{{ job.id }}"
                               data-title="999">
                                <span class="glyphicon glyphicon-play"></span>立即执行</a>
                            <a href="{% url "update_sync_plan" job.id %}?channel_id={{ job.channel_id }}&subchannel_id={{ job.subchannel_id }}&module_id={{ job.module_id }}&platform={{ job.platform }}&from=select_plans&back={{ plats.0 }}&back=all"
                               class="btn btn-small btn-warning" target="_blank">
                                <span class="glyphicon glyphicon-play"></span>修改</a>
                            <a href="{% url "del_sync_plan" job.id %}?channel_id={{ job.channel_id }}&subchannel_id={{ job.subchannel_id }}&module_id={{ job.module_id }}&platform={{ job.platform }}"
                               class="del btn btn-small btn-danger">
                                <span class="glyphicon glyphicon-play">删除</span></a>
                            <a href="{% url 'fetch_job_log_watch' job.id %}" class="btn btn-small btn-info"
                               target="_blank">
                                <span class="glyphicon glyphicon-play">日志</span></a>
                        </td>
                    {% endif %}

                </tr>
            {% endfor %}

            </tbody>
        </table>
    {% else %}
        <div>
            <div class="alert alert-info">
                <i class="icon-info-sign"></i>没有抓取计划!
            </div>
        </div>
    {% endif %}
    <div class="row-fluid">
        {% include "syncjob/add_syncjob_from_show_all.html" %}
    </div>

{% endblock %}


{% block js %}

    <script type="text/javascript">

        $(document).ready(function () {


            var slider_effect = function () {
                $("#display_filter").toggle('slow');
                $("#filter_block").slideToggle();
            };
            $("#display_filter").bind('click', slider_effect);
            $("#fade_filter").bind('click', slider_effect);

            $('#filter_name').focus(function () {
                var pre_name = '';
                setInterval(function () {
                    var v_name = $('#filter_name').val();
                    if (v_name === '') {
                        $(".virtual_name").each(function () {
                            $(this).parent().show();
                        })
                    } else if (v_name !== pre_name) {
                        pre_name = v_name;
                        $(".virtual_name").each(function () {
                            if ($(this).text().indexOf(v_name) < 0) {
                                $(this).parent().hide();
                            } else {
                                $(this).parent().show();
                            }
                        })
                    }
                }, 500);
            });

            $("#virtual_name").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "{% url "virtual_name_autocomplete" %}",
                        dataType: "json",
                        type: 'post',
                        data: {
                            'q': $("#virtual_name").val()
                        },
                        success: function (data) {
                            return response(data);
                        }
                    });
                },
                minLength: 1,
                autoFocus: true
            });

            $('.run').bind('click', function () {
                var obj = $(this);
                $.ajax({
                    url: "/content/sync/runatonce/plan/" + obj.data('job'),
                    dataType: "json",
                    type: 'get',
                    success: function (data) {
                        obj.tooltip({
                            title: data.status
                        }).tooltip('show');
                        setTimeout(function () {
                            obj.tooltip('hide').tooltip('destroy');
                        }, 1000);
                    }
                });
            });

            var run_type = $('#run_type');
            run_type.change(function () {
                if ($(this).val() === 'interval') {
                    $('#interval_type').show();
                    $('#cron_type').hide();
                } else {
                    $('#interval_type').hide();
                    $('#cron_type').show();
                }
            });
            run_type.triggerHandler('change');

            $(".data_tip").tooltip();

            $(".del").click(function () {

                var statu = confirm("确认删除吗?");
                if (!statu) {
                    return false;
                }
            });

        });
    </script>
    <link href="{{ STATIC_URL }}bootstrap-editable-1.5.1/bootstrap-editable/css/bootstrap-editable.css"
          rel="stylesheet"/>
    <script src="{{ STATIC_URL }}bootstrap-editable-1.5.1/bootstrap-editable/js/bootstrap-editable.js"></script>

{% endblock %}
{% extends "base.html" %}
{% block link %}
    <style type="text/css" mce_bogus="1">
        table th
        {
            white-space: nowrap;
        }
        table td
        {
            white-space: nowrap;
        }
    </style>
    <link href="{{ STATIC_URL }}css/page.css" rel="stylesheet">

{% endblock %}
{% load keyvalue %}
{% block content %}
    <div class="row-fluid" >
        <form role="form" action="/stat/app/category" id='index_query'>
            <input type="hidden" name='download' id='download'/>
            <input type="hidden" name='os' id='os'/>
            <input type="hidden" name='tabid' id='tabid' value="{{ cat_select }}"/>

                <div class="span4" style="width: 350px;margin-left: 0px;">
                    <div class="time">
                        <div class="controls input-append date form_date" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
                            <span class="add-on">从：</span>
                            <span class="add-on"><i class="icon-th"></i></span>
                            <input size="10" type="text" value="{{ date_from }}" readonly id='date_from' name='date_from'>
                        </div>
                        <div class="controls input-append date form_date" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
                            <span class="add-on">到：</span>
                            <span class="add-on"><i class="icon-th"></i></span>
                            <input size="10" type="text" value="{{ date_to }}" readonly id='date_to' name='date_to'>
                        </div>
                    </div>
                </div>
                <div class="span2" style="margin-left: 3px;">
                    <div class="input-prepend">
                        <span class="add-on">产品：</span>
                        <select id='product_select' class="span8" name='product_select'>
                            {% for ele in products %}
                                {% if ele.selected %}
                                    <option value="{{ ele.value }}" selected='{{ ele.selected }}'>{{ ele.name }}</option>
                                {% else %}
                                    <option value="{{ ele.value }}">{{ ele.name }}</option>
                                {% endif %}

                            {% endfor %}

                        </select>
                    </div>
                </div>
                <div class="span2" style="margin-left: 3px;">
                    <div class="input-prepend">
                        <span class="add-on">平台：</span>
                        <select id='platform_select' class="span8" name='platform_select'>
                            <option value="0">全部</option>
                            {% for ele in platform %}
                                {% if ele.selected %}
                                    <option value="{{ ele.value }}" selected='{{ ele.selected }}'>{{ ele.name }}</option>
                                {% else %}
                                    <option value="{{ ele.value }}">{{ ele.name }}</option>
                                {% endif %}
                            {% endfor %}

                        </select>
                    </div>
                </div>

                <div class="span2" style="margin-left: 3px;">
                    <div class="input-prepend">
                        <span class="add-on">终端：</span>
                        <select id='device_select' class="span8" name='device_select'>
                            {% for ele in devices %}
                                {% if ele.selected %}
                                    <option value="{{ ele.value }}" selected='{{ ele.selected }}'>{{ ele.name }}</option>
                                {% else %}
                                    <option value="{{ ele.value }}">{{ ele.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="span2" style="margin-left: 3px;">
                    <div class="input-prepend">
                        <span class="add-on">来源：</span>
                        <select id='source_select' class="span8" name='source_select'>
                            {% for ele in source %}
                                {% if ele.selected %}
                                    <option value="{{ ele.value }}" selected='{{ ele.selected }}'>{{ ele.name }}</option>
                                {% else %}
                                    <option value="{{ ele.value }}">{{ ele.name }}</option>
                                {% endif %}
                            {% endfor %}

                        </select>
                    </div>
                </div>
                <div  style="margin-right: 0px;">
                    <button type="button" class="btn btn-success" id='query_btn' download='0'>查询</button>
                </div>
        </form>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <ul class="nav nav-tabs" id="p_tab">

                {% for ele in tab_list %}
                    <li class="{{ ele.clazz }}"><a href="/stat/app/category?tabid={{ ele.id }}&date_from={{ date_from }}&date_to={{ date_to }}&product_select={{ product_select }}&source_select={{ source_select }}&device_select={{ device_select }}&platform_select={{ platform_select }}">{{ ele.name }}</a></li>
                {% endfor %}

            </ul>

        </div>
    </div>


    {% ifequal catid 0 %}
        <div class="row-fluid">
            <table>
                <tr>
                    <td>
                        <div id="pie" style="height: 400px;width: 500px;">
                            <script type="text/javascript" charset="utf-8">
                                PieChart('{{ pie_id|safe }}','{{ pie_title|safe }}','{{ pie_name|safe }}',{{ pies|safe }});
                            </script>
                        </div>
                    </td>
                    <td>
                        <div id="column_cats" style="height: 400px;">
                            <script type="text/javascript" charset="utf-8">
                                Column_rotated_labels('column_cats','每游戏平均下载次数',{{ categories_1|safe }},{{ datas_1|safe }},'平均下载次数');
                            </script>

                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <div class="row-fluid">
            <div class="span12">
                <table class="table table-hover table-bordered" id="general">
{#                    <h4>各类游戏基本数据</h4>#}
                    <button type="button" class="btn btn-success" onclick="getCSVData('general');">下载至Excel</button>
                    <thead>
                    <tr>
                        <th colspan="5" style="background-color: #e2edfb;">各类游戏基本数据</th>
                    </tr>
                    <tr>
                        <th>游戏类型</th>
                        <th>点击下载数</th>
                        <th>点击下载数占比</th>
                        <th>游戏个数</th>
                        <th>每游戏平均下载次数</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for item in items_list_1 %}
                        <tr>
                            <td><a href="/stat/app/detail?date_from={{ date_from }}&date_to={{ date_to }}&product_select={{ product_select }}&platform_select={{ platform_select }}&device_select={{ device_select }}&cat_select={{ item.category_id }}&source_select={{ source_select }}">{{ item.catname }}</a></td>
                            <td>{{ item.downloadnum }}</td>
                            <td>{{ item.game_category_rate }}%</td>
                            <td>{{ item.app_count }}</td>
                            <td>{{ item.per_game_download_time }}</td>

                        </tr>
                    {% endfor %}
                    <tr>
                        <td>合计</td>
                        {% for ele_sum in sum_app_list_1 %}
                            <td>{{ ele_sum }}</td>
                        {% endfor %}
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="row-fluid" id="line_basic_x">
            <script type="text/javascript" charset="utf-8">
                combo_dual_axes({{ categories_3|safe }},'{{ title_3|safe }}',{{ names_3|safe }},{{ datas_3|safe }},'line_basic_x');
            </script>

        </div>
        <div class="row-fluid">
            <div class="span12">
                <table class="table table-hover table-bordered" id="game_general">
{#                    <h4>{{ table_header_name }}游戏汇总趋势数据</h4>#}
                    <button type="button" class="btn btn-success" onclick="getCSVData('game_general');">下载至Excel</button>
                    <thead>
                    <tr>
                        <th colspan="4" style="background-color: #e2edfb;">{{ table_header_name }}游戏汇总趋势数据</th>
                    </tr>
                    <tr>
                        <th>日期</th>
                        {% for ele in tab_names_3 %}
                            <th>{{ ele }}</th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for items in items_list_3 %}
                        <tr>
                            {% for item in items %}
                                <td>{{ item }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    {% endifequal %}

    <div class="row-fluid" id="line_basic_app"><!-- tab下应用统计图-->
        <script type="text/javascript" charset="utf-8">
            line_basic_b({{ categories_2|safe }},'{{ title_2|safe }}',{{ names_2|safe }},{{ datas_2|safe }},{{ value_suffixs|safe }},'line_basic_app');
        </script>
    </div>
    <div class="row-fluid">
        <div class="span12">
{#            隐藏的表该表列了所有的APP专门为了下载准备的#}



            <table class="table table-hover table-bordered" id="game_list">
{#                <h4>{{ table_header_name }}游戏列表</h4>#}
{#                <button type="button" class="btn btn-success" onclick="getCSVData('game_list_hidden');">下载至Excel</button>#}
                <button type="button" class="btn btn-success" id='query_btn_download' download='1' os='MS Windows'>下载至Excel</button>
                <thead>
                <tr>
                    <th colspan="5" style="background-color: #e2edfb;">{{ table_header_name }}游戏列表</th>
                </tr>
                <tr>
                    <th>游戏名称</th>
                    {% for ele in tab_names_2 %}
                        <th>{{ ele }}</th>
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                {% for items in items_list_2 %}
                    <tr>
                        <td><a href="/stat/app/detail?date_from={{ date_from }}&date_to={{ date_to }}&product_select={{ product_select }}&platform_select={{ platform_select }}&device_select={{ device_select }}&cat_select={{ cat_select }}&app_select={{ items.appid }}&source_select={{ source_select }}">{{ items.appname }}</a></td>
                        <td>{{ items.download_d_num }}</td>
                        <td>{{ items.downloadnum }}</td>
                        <td>{{ items.download_s_num }}</td>
                        <td>{{ items.download_speed }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <td>合计</td>
                    {% for ele_sum in sum_app_list_2 %}
                        <td>{{ ele_sum }}</td>
                    {% endfor %}
                </tr>
                </tbody>
            </table>
            {{ pages|safe }}
        </div>
    </div>
    {#    为下载表格专门提供的form#}
    <form action="/stat/app/getcsv" method ="post" name="formCSV" accept-charset="utf8" >
        <input type="hidden" name="csv_text" id="csv_text">
    </form>

{##}
{##}
{#    <div style="height:1px;width:1px;overflow: hidden;">#}
{#        <table id="game_list_hidden">#}
{#            <thead>#}
{#            <tr>#}
{#                <th>游戏名称</th>#}
{#                {% for ele in tab_names_2 %}#}
{#                    <th>{{ ele }}</th>#}
{#                {% endfor %}#}
{#            </tr>#}
{#            </thead>#}
{#            <tbody>#}
{#            {% for items in hidden_apps %}#}
{#                <tr>#}
{#                    <td>{{ items.appname }}</td>#}
{#                    <td>{{ items.download_d_num }}</td>#}
{#                    <td>{{ items.downloadnum }}</td>#}
{#                    <td>{{ items.download_s_num }}</td>#}
{#                    <td>{{ items.download_speed }}</td>#}
{#                </tr>#}
{#            {% endfor %}#}
{#                <tr>#}
{#                    <td>合计</td>#}
{#                    <td>{{ sum_download_d_num }}</td>#}
{#                    <td>{{ sum_download_num }}</td>#}
{#                    <td>{{ sum_download_s_num }}</td>#}
{#                    <td></td>#}
{#                </tr>#}
{#            </tbody>#}
{#        </table>#}
{#    </div>#}


{% endblock %}
{% block js %}
    <script src="http://code.highcharts.com/modules/exporting.js"></script>
    <script type="text/javascript">

        $('#query_btn,#query_btn_download').click(function (e) {

{#            if ($(this).attr('id') == 'query_btn_download') {#}
{#                $('#download').val($(this).attr('download'));#}
{#                alert(5555)#}
{#                var os =check_os();#}
{#                $('#os').val(os);#}
{#                $('#index_query').submit();#}
{##}
{#            } else {#}
{#                $('#download').val();#}
{#                $('#index_query').submit();#}
{#            }#}
            $('#download').val($(this).attr('download'));
            var os =check_os();
            $('#os').val(os);
            $('#index_query').submit();

        });

    </script>
{% endblock %}

